---
# playbook_restart_proxy_services.yml
# Playbook para reiniciar servicios Squid, Privoxy y Tor en nodo espec√≠fico
# Nodo objetivo: 172.24.10.237

- name: "üîÑ Reinicio Controlado de Servicios Proxy"
  hosts: "{{ target_host | default('172.24.10.237') }}"
  gather_facts: yes
  become: yes
  serial: 1  # Importante: Reiniciar uno por uno si hay m√∫ltiples hosts
  
  vars:
    # Configuraci√≥n de servicios
    services_to_restart:
      - name: squid
        service: "{{ squid_service_name | default('squid') }}"
        port: "{{ squid_port | default(3128) }}"
        config_file: "{{ squid_config | default('/etc/squid/squid.conf') }}"
        check_command: "squid -k parse"
        dependencies: []
        
      - name: tor
        service: "{{ tor_service_name | default('tor') }}"
        port: "{{ tor_port | default(9050) }}"
        config_file: "{{ tor_config | default('/etc/tor/torrc') }}"
        check_command: "tor --verify-config"
        dependencies: []
        
      - name: privoxy
        service: "{{ privoxy_service_name | default('privoxy') }}"
        port: "{{ privoxy_port | default(8118) }}"
        config_file: "{{ privoxy_config | default('/etc/privoxy/config') }}"
        check_command: "privoxy --config-test {{ privoxy_config | default('/etc/privoxy/config') }}"
        dependencies: []
    
    # Par√°metros de ejecuci√≥n
    restart_timeout: 30
    max_retries: 3
    wait_between_services: 10
    backup_configs: true
    audit_log: "/var/log/proxy_restart_audit.log"
    
    # Notificaciones (opcional)
    send_notifications: false
    notification_email: "admin@example.com"
  
  # Pre-tasks: Validaciones previas
  pre_tasks:
    - name: "üìã Verificar que el host es alcanzable"
      ping:
      register: host_ping
    
    - name: "‚ö†Ô∏è Terminar si el host no es alcanzable"
      fail:
        msg: "Host {{ inventory_hostname }} no est√° alcanzable"
      when: host_ping.ping != "pong"
    
    - name: "üîç Detectar sistema operativo"
      debug:
        msg: "Sistema detectado: {{ ansible_distribution }} {{ ansible_distribution_version }}"
    
    - name: "üìä Verificar espacio en disco"
      shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
      register: disk_usage
      changed_when: false
    
    - name: "‚ö†Ô∏è Advertencia si espacio en disco es cr√≠tico"
      debug:
        msg: "‚ö†Ô∏è Advertencia: Uso de disco en / es {{ disk_usage.stdout }}% - Considera limpiar espacio"
      when: disk_usage.stdout | int > 80

  tasks:
    # Bloque 1: Verificar servicios instalados
    - name: "üì¶ Verificar que los servicios est√°n instalados"
      block:
        - name: "Obtener informaci√≥n de paquetes"
          package_facts:
        
        - name: "Mostrar estado de instalaci√≥n"
          debug:
            msg: |
              Servicios instalados en {{ inventory_hostname }}:
              {% for service in services_to_restart %}
              - {{ service.name }}: {{ '‚úÖ INSTALADO' if service.name in ansible_facts.packages else '‚ùå NO INSTALADO' }}
              {% endfor %}
      
      rescue:
        - name: "üö® Error verificando paquetes"
          debug:
            msg: "No se pudo verificar los paquetes instalados"
    
    # Bloque 2: Crear backup de configuraciones
    - name: "üíæ Crear backups de configuraciones"
      block:
        - name: "Crear directorio de backups"
          file:
            path: "/backup/proxy_configs/{{ ansible_date_time.date }}"
            state: directory
            mode: '0755'
          when: backup_configs
        
        - name: "Backup de archivos de configuraci√≥n"
          copy:
            remote_src: yes
            src: "{{ item.config_file }}"
            dest: "/backup/proxy_configs/{{ ansible_date_time.date }}/{{ item.name }}.conf.backup"
            mode: '0644'
          loop: "{{ services_to_restart }}"
          when: 
            - backup_configs
            - item.config_file is defined
          register: backup_results
          ignore_errors: yes
        
        - name: "Mostrar resultado de backups"
          debug:
            msg: "Backups creados: {{ backup_results.results | selectattr('changed') | map(attribute='item.name') | list }}"
          when: backup_configs
      
      tags: backup
    
    # Bloque 3: Verificar configuraciones antes de reiniciar
    - name: "üîß Validar configuraciones de servicios"
      block:
        - name: "Verificar sintaxis de configuraci√≥n"
          command: "{{ item.check_command }}"
          loop: "{{ services_to_restart }}"
          register: config_checks
          ignore_errors: yes
          changed_when: false
        
        - name: "Mostrar resultados de validaci√≥n"
          debug:
            msg: |
              Validaci√≥n de configuraciones:
              {% for check in config_checks.results %}
              - {{ services_to_restart[loop.index0].name }}: {{ '‚úÖ V√ÅLIDA' if check.rc == 0 else '‚ùå ERROR: ' + check.stderr }}
              {% endfor %}
      
      tags: validate
    
    # Bloque 4: Verificar conexiones activas
    - name: "üì° Verificar conexiones activas antes del reinicio"
      block:
        - name: "Contar conexiones activas por servicio"
          shell: |
            # Script para contar conexiones
            case "{{ item.name }}" in
              squid)
                netstat -an | grep :{{ item.port }} | grep ESTABLISHED | wc -l
                ;;
              tor)
                ss -tulpn | grep :{{ item.port }} | wc -l
                ;;
              privoxy)
                netstat -an | grep :{{ item.port }} | grep -i listen | wc -l
                ;;
              *)
                echo "0"
                ;;
            esac
          loop: "{{ services_to_restart }}"
          register: active_connections_before
          changed_when: false
        
        - name: "Mostrar conexiones activas"
          debug:
            msg: |
              Conexiones activas antes del reinicio:
              {% for conn in active_connections_before.results %}
              - {{ services_to_restart[loop.index0].name }}: {{ conn.stdout }} conexi√≥n(es)
              {% endfor %}
      
      tags: monitor
    
    # Bloque 5: Reiniciar servicios con manejo de errores
    - name: "üîÑ Reiniciar servicios proxy"
      block:
        - name: "Reiniciar cada servicio"
          systemd:
            name: "{{ item.service }}"
            state: restarted
            enabled: yes
            daemon_reload: yes
          loop: "{{ services_to_restart }}"
          register: restart_results
          async: "{{ restart_timeout }}"
          poll: 5
          retries: "{{ max_retries }}"
          delay: 5
          until: restart_results is succeeded
        
        - name: "Esperar entre servicios"
          pause:
            seconds: "{{ wait_between_services }}"
          when: wait_between_services > 0
        
        - name: "Mostrar resultados del reinicio"
          debug:
            msg: |
              Resultados del reinicio:
              {% for result in restart_results.results %}
              - {{ services_to_restart[loop.index0].name }}: {{ '‚úÖ REINICIADO' if result.changed else '‚ö†Ô∏è SIN CAMBIOS (ya estaba corriendo)' }}
              {% endfor %}
      
      rescue:
        - name: "üö® Error reiniciando servicios - Intentar inicio simple"
          debug:
            msg: "Error en reinicio, intentando inicio simple"
          
          - name: "Intentar start en lugar de restart"
            systemd:
              name: "{{ item.service }}"
              state: started
            loop: "{{ services_to_restart }}"
            when: restart_results.failed
      
      tags: restart
    
    # Bloque 6: Verificar servicios despu√©s del reinicio
    - name: "‚úÖ Verificaci√≥n post-reinicio"
      block:
        - name: "Verificar estado de servicios"
          systemd:
            name: "{{ item.service }}"
          loop: "{{ services_to_restart }}"
          register: service_status_after
          changed_when: false
        
        - name: "Verificar puertos en escucha"
          wait_for:
            host: "{{ ansible_default_ipv4.address | default('127.0.0.1') }}"
            port: "{{ item.port }}"
            state: started
            delay: 5
            timeout: 30
          loop: "{{ services_to_restart }}"
          register: port_checks
        
        - name: "Contar conexiones despu√©s del reinicio"
          shell: |
            sleep 5  # Esperar estabilizaci√≥n
            case "{{ item.name }}" in
              squid)
                netstat -an | grep :{{ item.port }} | grep ESTABLISHED | wc -l
                ;;
              tor)
                ss -tulpn | grep :{{ item.port }} | wc -l
                ;;
              privoxy)
                netstat -an | grep :{{ item.port }} | grep -i listen | wc -l
                ;;
              *)
                echo "0"
                ;;
            esac
          loop: "{{ services_to_restart }}"
          register: active_connections_after
          changed_when: false
        
        - name: "üìã Generar reporte de verificaci√≥n"
          debug:
            msg: |
              ================================================
              üéØ REPORTE DE VERIFICACI√ìN - {{ inventory_hostname }}
              ================================================
              {% for service in services_to_restart %}
              {{ service.name | upper }}:
                Estado servicio: {{ service_status_after.results[loop.index0].state }}
                Activo: {{ service_status_after.results[loop.index0].active }}
                Puerto {{ service.port }}: {{ '‚úÖ ESCUCHANDO' if port_checks.results[loop.index0].state == 'started' else '‚ùå NO ESCUCHA' }}
                Conexiones antes: {{ active_connections_before.results[loop.index0].stdout }}
                Conexiones despu√©s: {{ active_connections_after.results[loop.index0].stdout }}
              {% endfor %}
              ================================================
      
      tags: verify
    
    # Bloque 7: Pruebas funcionales
    - name: "üß™ Pruebas funcionales de servicios"
      block:
        - name: "Probar Squid - HTTP request b√°sica"
          shell: |
            timeout 10 curl -s -o /dev/null -w "%{http_code}" -x http://localhost:{{ squid_port | default(3128) }} http://example.com || echo "FAILED"
          register: squid_test
          ignore_errors: yes
          when: "'squid' in ansible_facts.packages"
        
        - name: "Probar Tor - Verificar conexi√≥n Tor"
          shell: |
            timeout 15 curl -s --socks5 localhost:{{ tor_port | default(9050) }} http://check.torproject.org | grep -q "Congratulations" && echo "TOR_OK" || echo "TOR_FAILED"
          register: tor_test
          ignore_errors: yes
          when: "'tor' in ansible_facts.packages"
        
        - name: "Probar Privoxy - HTTP request"
          shell: |
            timeout 10 curl -s -o /dev/null -w "%{http_code}" -x http://localhost:{{ privoxy_port | default(8118) }} http://example.com || echo "FAILED"
          register: privoxy_test
          ignore_errors: yes
          when: "'privoxy' in ansible_facts.packages"
        
        - name: "Mostrar resultados de pruebas"
          debug:
            msg: |
              Pruebas funcionales:
              - Squid: {{ '‚úÖ FUNCIONA' if squid_test.stdout == '200' else '‚ùå FALLA: ' + squid_test.stdout }}
              - Tor: {{ '‚úÖ FUNCIONA' if tor_test.stdout == 'TOR_OK' else '‚ùå FALLA' }}
              - Privoxy: {{ '‚úÖ FUNCIONA' if privoxy_test.stdout == '200' else '‚ùå FALLA: ' + privoxy_test.stdout }}
      
      tags: test

  # Post-tasks: Limpieza y reporte final
  post_tasks:
    - name: "üìù Registrar en log de auditor√≠a"
      block:
        - name: "Crear entrada de log"
          lineinfile:
            path: "{{ audit_log }}"
            line: |
              [{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} - REINICIO PROXY
              Servicios: squid, tor, privoxy
              Usuario: {{ ansible_user_id }}
              Resultado: {{ 'EXITOSO' if restart_results is defined and not restart_results.failed else 'FALLIDO' }}
              =================================
            create: yes
            owner: root
            group: root
            mode: '0644'
      
      tags: audit
    
    - name: "üì§ Enviar notificaci√≥n por email (opcional)"
      mail:
        to: "{{ notification_email }}"
        subject: "Reinicio de servicios proxy - {{ inventory_hostname }}"
        body: |
          Reinicio de servicios proxy completado en {{ inventory_hostname }}
          
          Servicios reiniciados:
          - Squid: {{ '‚úÖ' if squid_test.stdout == '200' else '‚ùå' }}
          - Tor: {{ '‚úÖ' if tor_test.stdout == 'TOR_OK' else '‚ùå' }}
          - Privoxy: {{ '‚úÖ' if privoxy_test.stdout == '200' else '‚ùå' }}
          
          Hora: {{ ansible_date_time.iso8601 }}
          Usuario: {{ ansible_user_id }}
      delegate_to: localhost
      when: send_notifications and notification_email is defined
    
    - name: "üéâ Resumen final de ejecuci√≥n"
      debug:
        msg: |
          ================================================
          ‚úÖ REINICIO COMPLETADO EN {{ inventory_hostname }}
          ================================================
          Servicios procesados: {{ services_to_restart | length }}
          Tiempo estimado: {{ (restart_timeout * services_to_restart | length) + (wait_between_services * (services_to_restart | length - 1)) }} segundos
          Log de auditor√≠a: {{ audit_log }}
          Backup creado: {{ 'S√≠' if backup_configs else 'No' }}
          ================================================
          Comandos de verificaci√≥n manual:
          - Squid: systemctl status squid
          - Tor: systemctl status tor
          - Privoxy: systemctl status privoxy
          ================================================

  # Handlers para operaciones espec√≠ficas
  handlers:
    - name: "üîÑ Reload systemd daemon"
      systemd:
        daemon_reload: yes
      listen: "reload systemd"
    
    - name: "üìä Generar reporte detallado"
      copy:
        dest: "/tmp/proxy_restart_report_{{ ansible_date_time.date }}.txt"
        content: |
          Reporte de reinicio - {{ inventory_hostname }}
          Fecha: {{ ansible_date_time.iso8601 }}
          {% for service in services_to_restart %}
          {{ service.name }}:
            Estado: {{ service_status_after.results[loop.index0].state | default('UNKNOWN') }}
            Puerto: {{ service.port }}
            Config: {{ service.config_file }}
          {% endfor %}
      listen: "generate report"
    
    - name: "üîî Notificar canal de monitoreo"
      debug:
        msg: "Notificar a canal de monitoreo sobre reinicio"
      listen: "notify monitoring"

  # Manejo de errores global
  rescue:
    - name: "üö® CAPTURA DE ERROR GLOBAL"
      debug:
        msg: |
          ERROR DETECTADO EN EL PLAYBOOK
          Host: {{ inventory_hostname }}
          Tarea fallida: {{ ansible_failed_task.name }}
          Error: {{ ansible_failed_result.msg }}
      
    - name: "üÜò Primeros auxilios - Verificar servicios ca√≠dos"
      shell: |
        for service in squid tor privoxy; do
          if systemctl is-active --quiet $service; then
            echo "$service: ACTIVE"
          else
            echo "$service: INACTIVE - Attempting start..."
            systemctl start $service
          fi
        done
      register: first_aid
      
    - name: "üìû Instrucciones de recuperaci√≥n"
      debug:
        msg: |
          INSTRUCCIONES DE RECUPERACI√ìN:
          1. Verificar logs: journalctl -u squid -u tor -u privoxy --since "5 minutes ago"
          2. Revisar configuraciones en /backup/proxy_configs/
          3. Intentar inicio manual: systemctl start squid tor privoxy
          4. Verificar puertos: netstat -tulpn | grep -E ':(3128|9050|8118)'